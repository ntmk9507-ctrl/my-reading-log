<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çŸ¥ã®æ›¸åº« - é€£æŠ•ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ‰</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        :root { --primary: #5e72e4; }
        body { background-color: #f4f7f9; padding-bottom: 40px; }
        .container { max-width: 600px; margin-top: 15px; }
        .book-focus-card { 
            background: #fff; padding: 15px; border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px;
            border-left: 5px solid var(--primary);
        }
        .memo-area { background: #fff; padding: 20px; border-radius: 12px; }
        .status-badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; background: #e2e8f0; margin-left: 10px; }
        .hidden { display: none; }
        .flex-row { display: flex; gap: 10px; align-items: flex-end; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: 0.3s; pointer-events: none; }
    </style>
</head>
<body>

<main class="container">
    <header>
        <h3 style="text-align: center;">ğŸ“š èª­æ›¸æ€è€ƒãƒ­ã‚°</h3>
    </header>

    <div id="search-section">
        <label for="isbn">ISBNã‚’å…¥åŠ›ã—ã¦æœ¬ã‚’å›ºå®š</label>
        <div class="flex-row">
            <input type="number" id="isbn" placeholder="9784..." pattern="\d*">
            <button onclick="searchAndFixBook()" style="width: auto;">å›ºå®š</button>
        </div>
    </div>

    <div id="active-book" class="hidden">
        <div class="book-focus-card">
            <div style="display: flex; justify-content: space-between;">
                <div>
                    <strong id="display-title">ã‚¿ã‚¤ãƒˆãƒ«</strong>
                    <div id="display-author" style="font-size: 0.8rem; color: #666;"></div>
                </div>
                <button onclick="resetBook()" class="outline secondary" style="font-size: 0.6rem; width: auto; padding: 5px 10px;">æœ¬ã‚’å¤‰æ›´</button>
            </div>
        </div>

        <div class="memo-area">
            <div class="flex-row">
                <div style="flex: 1;">
                    <label for="page">ãƒšãƒ¼ã‚¸ (ä»»æ„)</label>
                    <input type="number" id="page" placeholder="p.123">
                </div>
                <div style="flex: 2;">
                    <label for="category">ã‚«ãƒ†ã‚´ãƒª</label>
                    <select id="category"></select> </div>
                <button onclick="addCategory()" class="outline" style="width: auto; padding: 5px 10px; margin-bottom: var(--spacing);">ï¼‹</button>
            </div>

            <label for="memo">ä»Šã®æ°—ã¥ããƒ»ãƒ¡ãƒ¢</label>
            <textarea id="memo" rows="4" placeholder="æ„Ÿã˜ãŸã“ã¨ã€å¼•ç”¨ãªã©è‡ªç”±ã«..."></textarea>
            
            <button id="submit-btn" onclick="sendMemo()" class="primary">ãƒ¡ãƒ¢ã‚’é€ä¿¡</button>
        </div>
    </div>

    <div id="toast" class="toast">Notionã«é€ä¿¡ã—ã¾ã—ãŸ</div>
</main>

<script>
    let currentBook = null;
    let categories = ["ä»•äº‹è¡“", "å¿ƒç†å­¦", "æ•™é¤Š", "æŠ€è¡“æ›¸"];

    // ã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆã®æç”»
    function renderCategories() {
        const select = document.getElementById('category');
        select.innerHTML = "";
        categories.sort().forEach(c => {
            const opt = document.createElement('option');
            opt.value = opt.textContent = c;
            select.appendChild(opt);
        });
        const other = document.createElement('option');
        other.value = other.textContent = "ãã®ä»–";
        select.appendChild(other);
    }

    function addCategory() {
        const newCat = prompt("æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªãƒ¼å:");
        if (newCat && !categories.includes(newCat)) {
            categories.push(newCat);
            renderCategories();
            document.getElementById('category').value = newCat;
        }
    }

    // æœ¬ã®æ¤œç´¢ã¨ç”»é¢åˆ‡ã‚Šæ›¿ãˆï¼ˆä¿®æ­£ç‰ˆï¼‰
ã€€ã€€async function searchAndFixBook() {
    ã€€ã€€const isbnInput = document.getElementById('isbn').value.trim();
    ã€€ã€€// ãƒã‚¤ãƒ•ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã¦ã‚‚å¤§ä¸ˆå¤«ãªã‚ˆã†ã«æ•°å­—ä»¥å¤–ã‚’é™¤å»
    	const cleanIsbn = isbnInput.replace(/\D/g, '');

ã€€ã€€    if (cleanIsbn.length < 10) {
    ã€€ã€€    alert("ISBNã‚³ãƒ¼ãƒ‰ï¼ˆ10æ¡ã¾ãŸã¯13æ¡ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        ã€€ã€€return;
    ã€€ã€€}

ã€€ã€€    try {
    ã€€ã€€    // q=isbn: ã‚’ã¤ã‘ã‚‹ã“ã¨ã§æ¤œç´¢ç²¾åº¦ã‚’ä¸Šã’ã¾ã™
       ã€€ã€€ const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${cleanIsbn}`);
   ã€€ã€€     const data = await res.json();
        
       ã€€ã€€ if (data.items && data.items.length > 0) {
           ã€€ã€€ currentBook = data.items[0].volumeInfo;
          ã€€ã€€  currentBook.isbn = cleanIsbn; 
            
        ã€€ã€€    document.getElementById('display-title').innerText = currentBook.title;
         ã€€ã€€   document.getElementById('display-author').innerText = currentBook.authors?.join(', ') || 'ä¸æ˜';
            
           ã€€ã€€ document.getElementById('search-section').classList.add('hidden');
          ã€€ã€€  document.getElementById('active-book').classList.remove('hidden');
        ã€€ã€€} else {
           ã€€ã€€ // ISBNã§è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã®äºˆå‚™ï¼šã‚¿ã‚¤ãƒˆãƒ«æ¤œç´¢ã‚’è©¦ã™ã‹è­¦å‘Š
            ã€€ã€€alert("Google Booksã§æœ¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ç•ªå·ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        ã€€ã€€}
   ã€€ã€€ } catch (e) { 
       ã€€ã€€ console.error(e);
        ã€€ã€€alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); 
    ã€€ã€€}
ã€€ã€€}

    function resetBook() {
        if(confirm("åˆ¥ã®æœ¬ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ")) {
            currentBook = null;
            document.getElementById('search-section').classList.remove('hidden');
            document.getElementById('active-book').classList.add('hidden');
        }
    }

    // ãƒ¡ãƒ¢é€ä¿¡ï¼ˆé€£æŠ•å¯¾å¿œï¼‰
    async function sendMemo() {
        const memoText = document.getElementById('memo').value;
        const pageNum = document.getElementById('page').value;
        
        if (!memoText) { alert("ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

        const gasUrl = "ã‚ãªãŸã®GASã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURL"; // â˜…å¾Œã»ã©ã“ã“ã«è²¼ã‚‹

        const payload = {
            title: currentBook.title,
            author: currentBook.authors?.join(', ') || 'ä¸æ˜',
            isbn: currentBook.isbn,
            category: document.getElementById('category').value,
            memo: memoText,
            page: pageNum ? `p.${pageNum}` : "" // ç©ºæ¬„OK
        };

        // GASã¸é€ä¿¡ (mode: 'no-cors' ã§ãƒ–ãƒ©ã‚¦ã‚¶åˆ¶é™ã‚’å›é¿)
        fetch(gasUrl, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(payload)
        });

        // é€ä¿¡å¾Œã®UIå‡¦ç†
        showToast();
        document.getElementById('memo').value = ""; // ãƒ¡ãƒ¢æ¬„ã ã‘ç©ºã«ã™ã‚‹
        // ãƒšãƒ¼ã‚¸æ•°ã¯ã‚ãˆã¦æ®‹ã™ã‹ç©ºã«ã™ã‚‹ã‹é¸ã¹ã¾ã™ãŒã€ä¸€æ—¦æ®‹ã™ã¨ä¾¿åˆ©ãªã®ã§ãã®ã¾ã¾
        document.getElementById('memo').focus();
    }

    function showToast() {
        const t = document.getElementById('toast');
        t.style.opacity = "1";
        setTimeout(() => { t.style.opacity = "0"; }, 2000);
    }

    renderCategories();
</script>

</body>
</html>